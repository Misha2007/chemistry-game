<!doctype html>
<html lang="et">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <title>Keemia Definitsioonide M√§ng</title>

    <style>
      body {
        margin: 0;
        font-family: "Segoe UI", sans-serif;
        background: linear-gradient(135deg, #141e30, #243b55);
        padding: 90px 20px 40px 20px;
      }

      .back-btn-top {
        position: fixed;
        top: 20px;
        left: 20px;
      }
      .back-btn {
        background: white;
        color: #141e30;
        padding: 10px 18px;
        border-radius: 8px;
        font-weight: bold;
        cursor: pointer;
        border: none;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        transition: 0.2s;
      }
      .back-btn:hover {
        background: #0072ff;
        color: white;
      }

      .container {
        background: white;
        padding: 40px;
        border-radius: 20px;
        max-width: 900px;
        margin: auto;
        box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3);
      }

      .blank {
        position: relative;
        display: inline-block;
        min-width: 140px;
        padding: 4px 6px; /* visible padding */
        margin: 5px;
        font-weight: bold;
        border-bottom: 2px solid black;
        cursor: pointer;
        z-index: 0;
      }

      /* Invisible hit area for easier drops */
      .blank::before {
        content: "";
        position: absolute;
        top: -18px; /* expand above */
        bottom: -18px; /* expand below */
        left: -10px; /* expand left */
        right: -10px; /* expand right */
        z-index: -1; /* behind text */
      }

      .word {
        display: inline-block;
        background: #eee;
        padding: 10px 16px;
        margin: 8px;
        border-radius: 10px;
        cursor: grab;
        font-weight: 600;
        touch-action: none; /* prevents scrolling on mobile while dragging */
        position: relative;
      }

      .word:active {
        cursor: grabbing;
      }

      button.action {
        padding: 12px 20px;
        margin: 15px 5px 0 5px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: bold;
        transition: all 0.2s ease;
      }

      /* CHECK BUTTON (default active style) */
      #checkBtn:not(:disabled) {
        background: #0072ff;
        color: white;
      }

      #checkBtn {
        width: 100%;
      }

      /* NEXT LEVEL BUTTON (stronger color) */
      .top-buttons button {
        padding: 10px 18px;
        border-radius: 8px;
        border: none;
        cursor: pointer;
        font-weight: bold;
        transition: all 0.2s ease;
      }

      /* Disabled state for top buttons */
      .top-buttons button:disabled {
        background: #cccccc;
        color: #666666;
        cursor: not-allowed;
      }

      /* Next level more noticeable */
      #nextBtn:not(:disabled) {
        background: #27ae60;
        color: white;
        box-shadow: 0 0 10px rgba(39, 174, 96, 0.7);
        animation: pulse 1.2s infinite;
      }

      @keyframes pulse {
        0% {
          box-shadow: 0 0 5px rgba(39, 174, 96, 0.5);
        }
        50% {
          box-shadow: 0 0 20px rgba(39, 174, 96, 1);
        }
        100% {
          box-shadow: 0 0 5px rgba(39, 174, 96, 0.5);
        }
      }

      /* Disabled state */
      button.action:disabled {
        background: #cccccc;
        color: #666666;
        cursor: not-allowed;
        transform: none;
        filter: none;
      }

      #explanations {
        margin-top: 25px;
        text-align: left;
        background: #f4f4f4;
        padding: 15px;
        border-radius: 10px;
        min-height: 60px;
      }
      #completionModal {
        display: none; /* hidden by default */
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5); /* semi-transparent overlay */
        justify-content: center;
        align-items: center;
        z-index: 9999;
      }

      #completionModal .modal-content {
        background: white;
        padding: 30px 40px;
        border-radius: 15px;
        text-align: center;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      }

      #completionModal button {
        width: 100%;
      }
    </style>
  </head>

  <body>
    <div id="completionModal">
      <div class="modal-content">
        <h2>üéâ K√µik tasemed on l√§bitud!</h2>
        <button class="back-btn" onclick="window.location.href = 'index.html'">
          Tagasi men√º√ºsse
        </button>
      </div>
    </div>
    <button
      class="back-btn back-btn-top"
      onclick="window.location.href = 'index.html'"
    >
      ‚Üê Tagasi men√º√ºsse
    </button>

    <div class="container">
      <div
        class="top-bar"
        style="
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 20px;
        "
      >
        <h2 id="levelTitle" style="margin: 0"></h2>
        <div class="top-buttons" style="display: flex; gap: 10px">
          <button class="action" onclick="redoPuzzle()" title="Proovi uuesti">
            <i class="fas fa-rotate-right"></i>
          </button>

          <!-- Next level button as icon -->
          <button
            id="nextBtn"
            class="action"
            onclick="nextLevel()"
            disabled
            title="J√§rgmine tase"
          >
            <i class="fas fa-arrow-right"></i>
          </button>
        </div>
      </div>

      <div id="sentenceContainer"></div>
      <div id="words"></div>

      <button id="checkBtn" class="action" onclick="checkAnswers()" disabled>
        Kontrolli
      </button>

      <div id="explanations">
        <strong>Selgitused ilmuvad siia p√§rast kontrolli</strong>
      </div>
    </div>

    <script>
      let currentLevel = 0;
      let draggedWord = null; // mobile drag variable

      const levels = [
        {
          title: "Tase 1",
          sentence: `Oksiidid on ained, mis koosnevad kahest 
<span class="blank" data-answer="elemendist"></span>, 
millest √ºks on 
<span class="blank" data-answer="hapnik"></span>.`,
          words: [
            {
              text: "elemendist",
              explanation: "Oksiid koosneb kahest elemendist.",
            },
            {
              text: "hapnik",
              explanation: "Oksiidi koostises peab olema hapnik.",
            },
            {
              text: "metallist",
              explanation: "Vale ‚Äì oksiid ei pea koosnema ainult metallist.",
            },
          ],
        },

        {
          title: "Tase 2",
          sentence: `Oksiid on elemendi √ºhend 
<span class="blank" data-answer="hapnikuga"></span>.`,
          words: [
            {
              text: "hapnikuga",
              explanation: "Oksiid tekib elemendi reageerimisel hapnikuga.",
            },
            {
              text: "vesinikuga",
              explanation: "Vale ‚Äì see moodustaks h√ºdriidi.",
            },
          ],
        },

        {
          title: "Tase 3",
          sentence: `Lihtained jagunevad 
<span class="blank" data-answer="metallideks"></span> 
ja 
<span class="blank" data-answer="mittemetallideks"></span>.`,
          words: [
            {
              text: "metallideks",
              explanation: "Metallid on √ºks lihtainete r√ºhm.",
            },
            {
              text: "mittemetallideks",
              explanation: "Mittemetallid on teine lihtainete r√ºhm.",
            },
            {
              text: "hapeteks",
              explanation: "Vale ‚Äì happed ei ole lihtained.",
            },
          ],
        },

        {
          title: "Tase 4",
          sentence: `Happed annavad vesilahusesse 
<span class="blank" data-answer="vesinikioone"></span>.`,
          words: [
            { text: "vesinikioone", explanation: "Happed annavad H+ ioone." },
            {
              text: "h√ºdroksiidioone",
              explanation: "Vale ‚Äì neid annavad alused.",
            },
          ],
        },

        {
          title: "Tase 5",
          sentence: `Alused annavad vesilahusesse 
<span class="blank" data-answer="h√ºdroksiidioone"></span>.`,
          words: [
            {
              text: "h√ºdroksiidioone",
              explanation: "Alused annavad OH- ioone.",
            },
            {
              text: "vesinikioone",
              explanation: "Vale ‚Äì neid annavad happed.",
            },
          ],
        },

        {
          title: "Tase 6",
          sentence: `Soolad koosnevad 
<span class="blank" data-answer="metallist"></span> 
ja 
<span class="blank" data-answer="happej√§√§gist"></span>.`,
          words: [
            { text: "metallist", explanation: "Sool sisaldab metalliooni." },
            { text: "happej√§√§gist", explanation: "Sool sisaldab happej√§√§ki." },
            {
              text: "vesinikust",
              explanation: "Vale ‚Äì vesinik ei ole alati soola koostises.",
            },
          ],
        },

        {
          title: "Tase 7",
          sentence: `Neutraalse lahuse pH on 
<span class="blank" data-answer="7"></span>.`,
          words: [
            { text: "7", explanation: "Neutraalses lahuses pH = 7." },
            { text: "3", explanation: "Vale ‚Äì see on happeline." },
          ],
        },

        {
          title: "Tase 8",
          sentence: `Happelises lahuses on 
<span class="blank" data-answer="vesinikioone"></span> 
rohkem kui h√ºdroksiidioone.`,
          words: [
            {
              text: "vesinikioone",
              explanation: "Happelises lahuses on H+ √ºlekaalus.",
            },
            {
              text: "h√ºdroksiidioone",
              explanation: "Vale ‚Äì neid on rohkem aluselises lahuses.",
            },
          ],
        },

        {
          title: "Tase 9",
          sentence: `Aluselises lahuses on rohkem 
<span class="blank" data-answer="h√ºdroksiidioone"></span> 
kui vesinikioone.`,
          words: [
            {
              text: "h√ºdroksiidioone",
              explanation: "Aluselises lahuses on OH- √ºlekaalus.",
            },
            {
              text: "vesinikioone",
              explanation: "Vale ‚Äì see iseloomustab happelist lahust.",
            },
          ],
        },

        {
          title: "Tase 10",
          sentence: `Indikaator on aine, mille v√§rvus s√µltub 
<span class="blank" data-answer="lahuse keskkonnast"></span>.`,
          words: [
            {
              text: "lahuse keskkonnast",
              explanation: "Indikaator muudab v√§rvi s√µltuvalt pH-st.",
            },
            {
              text: "temperatuurist",
              explanation:
                "Vale ‚Äì temperatuur ei m√§√§ra indikaatori p√µhifunktsiooni.",
            },
          ],
        },
      ];
      function loadLevel() {
        const level = levels[currentLevel];
        document.getElementById("levelTitle").innerText = level.title;
        document.getElementById("sentenceContainer").innerHTML = level.sentence;

        const wordsContainer = document.getElementById("words");
        wordsContainer.innerHTML = "";

        level.words
          .sort(() => Math.random() - 0.5)
          .forEach((w) => {
            const div = document.createElement("div");
            div.className = "word";
            div.innerText = w.text;
            div.draggable = true;

            // Desktop drag
            div.addEventListener("dragstart", (e) => {
              e.dataTransfer.setData("text", w.text);
            });

            // Mobile touch drag
            div.addEventListener("touchstart", touchStart, { passive: false });
            div.addEventListener("touchmove", touchMove, { passive: false });
            div.addEventListener("touchend", touchEnd);

            wordsContainer.appendChild(div);
          });

        initBlanks();
      }

      function initBlanks() {
        document.getElementById("checkBtn").disabled = true;
        document.getElementById("nextBtn").disabled = true;

        document.querySelectorAll(".blank").forEach((blank) => {
          blank.innerText = "";
          blank.style.backgroundColor = "";

          blank.addEventListener("dragover", (e) => e.preventDefault());

          blank.addEventListener("drop", (e) => {
            e.preventDefault();
            blank.innerText = e.dataTransfer.getData("text");
            updateCheckButtonState();
          });

          // Mobile touch "tap-to-fill"
          blank.addEventListener("touchstart", (e) => {
            if (draggedWord) {
              blank.innerText = draggedWord.innerText;
              updateCheckButtonState();
              draggedWord.style.position = "relative";
              draggedWord = null;
            }
          });
        });
      }

      function updateCheckButtonState() {
        const blanks = document.querySelectorAll(".blank");
        const allFilled = [...blanks].every(
          (blank) => blank.innerText.trim() !== "",
        );
        document.getElementById("checkBtn").disabled = !allFilled;
      }

      function checkAnswers() {
        let explanationsHTML = "";
        let allCorrect = true;
        const level = levels[currentLevel];

        document.querySelectorAll(".blank").forEach((blank) => {
          const userAnswer = blank.innerText.trim();
          const correct = blank.dataset.answer;

          if (userAnswer === correct) {
            blank.style.backgroundColor = "#2ecc71";
            explanationsHTML += `<p><strong>${userAnswer}</strong>: √ïige! ‚úî</p>`;
          } else {
            blank.style.backgroundColor = "#e74c3c";
            const explanation = level.words.find(
              (w) => w.text === correct,
            )?.explanation;
            explanationsHTML += `<p><strong>${userAnswer || "[t√ºhi]"}</strong>: Vale ‚ùå √ïige: ${correct}. ${explanation}</p>`;
            allCorrect = false;
          }
        });

        document.getElementById("explanations").innerHTML = explanationsHTML;
        document.getElementById("nextBtn").disabled = !allCorrect;
        document.getElementById("checkBtn").disabled = allCorrect;
      }

      function redoPuzzle() {
        loadLevel();
        document.getElementById("explanations").innerHTML =
          "<strong>Selgitused ilmuvad siia p√§rast kontrolli</strong>";
      }

      function nextLevel() {
        currentLevel++;
        if (currentLevel >= levels.length) {
          // Show modal instead of alert
          document.getElementById("completionModal").style.display = "flex";
          currentLevel = 0;
          return;
        }
        loadLevel();
      }

      // --- Mobile touch drag functions ---
      function touchStart(e) {
        draggedWord = e.target;
        draggedWord.style.position = "absolute";
        draggedWord.style.zIndex = 1000;
      }

      function touchMove(e) {
        e.preventDefault();
        const touch = e.touches[0];
        draggedWord.style.left =
          touch.clientX - draggedWord.offsetWidth / 2 + "px";
        draggedWord.style.top =
          touch.clientY - draggedWord.offsetHeight / 2 + "px";
      }

      function touchEnd(e) {
        if (draggedWord) {
          const touch = e.changedTouches[0];
          const x = touch.clientX;
          const y = touch.clientY;

          // Temporarily hide dragged word so elementFromPoint can detect the blank
          draggedWord.style.display = "none";
          const blank = document.elementFromPoint(x, y);
          draggedWord.style.display = "inline-block";

          if (blank && blank.classList.contains("blank")) {
            blank.innerText = draggedWord.innerText;
            updateCheckButtonState();

            // reset dragged word position
            draggedWord.style.position = "relative";
            draggedWord.style.left = "0px";
            draggedWord.style.top = "0px";
            draggedWord = null;
          }

          // Reset dragged word position
          draggedWord.style.position = "relative";
          draggedWord.style.left = "0px";
          draggedWord.style.top = "0px";
          draggedWord = null;
        }
      }

      loadLevel();
    </script>
  </body>
</html>
